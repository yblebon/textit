<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Secure Drop • @YasserLebon</title>
<style>
  body{font-family:Arial,sans-serif;max-width:1000px;margin:40px auto;padding:20px;background:#f4f4f9;color:#333;line-height:1.6}
  h1{color:#2c3e50;text-align:center;margin-bottom:10px}
  .subtitle{color:#7f8c8d;text-align:center;font-size:15px;margin-bottom:30px}
  .tabs{text-align:center;margin-bottom:30px}
  .tab-btn{padding:12px 32px;margin:0 8px;font-size:17px;border:none;border-radius:8px;cursor:pointer;background:#ddd;transition:all .3s}
  .tab-btn.active{background:#27ae60;color:white}
  .tab-btn:hover{background:#2ecc71;color:white}
  .tab-content{background:#fff;padding:40px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,.1);display:none}
  .tab-content.active{display:block}
  label{display:block;margin-top:22px;font-weight:bold}
  input,textarea,select{width:100%;padding:12px;margin-top:8px;border:1px solid #ddd;border-radius:6px;font-size:16px;box-sizing:border-box}
  textarea{height:160px;resize:vertical;font-family:monospace}
  button.main-btn{margin-top:30px;padding:14px 32px;background:#27ae60;color:#fff;border:none;border-radius:8px;font-size:17px;cursor:pointer;width:100%}
  button.main-btn:hover{background:#1e8449}
  button.main-btn:disabled{background:#95a5a6;cursor:not-allowed}
  .result{margin-top:25px;padding:20px;border-radius:8px;font-family:monospace}
  .success{color:#27ae60;background:#d5f5e3}
  .error{color:#e74c3c;background:#fadbd8}
  .hidden{display:none}
  .warn{color:#e67e22;font-size:14px;margin-top:5px}
  .loader{margin-top:10px;color:#7f8c8d;font-style:italic}
  .meta{background:#f8f9fa;padding:18px;border-radius:8px;margin-top:20px;font-size:14px}
  .meta pre{background:#f0f0f0;padding:12px;border-radius:6px;overflow-x:auto}
  .file-info{padding:12px;background:#fff3cd;border-radius:6px;font-weight:bold;margin-top:15px}
  .pass-wrapper{position:relative}
  .pass-wrapper input{padding-right:44px}
  .toggle-pass{position:absolute;right:10px;top:44px;cursor:pointer;font-size:18px;user-select:none;color:#7f8c8d}
  .toggle-pass:hover{color:#2c3e50}
</style>
</head>
<body>
<h1>Secure Drop</h1>
<div class="subtitle">
  Private encrypted messages • @YasserLebon • France<br>
  <small>November 18, 2025</small>
</div>

<div class="tabs">
  <button class="tab-btn active" data-tab="encrypt">Encrypt & Send</button>
  <button class="tab-btn" data-tab="decrypt">Decrypt Message</button>
</div>

<div id="encrypt" class="tab-content active">
  <label for="msg">Your Secret Message</label>
  <textarea id="msg" placeholder="Type your confidential message here..."></textarea>
  <label for="pw1">Encryption Password</label>
  <div class="pass-wrapper"><input type="password" id="pw1"><span class="toggle-pass" data-target="pw1">Show</span></div>
  <label for="pw2">Confirm Password</label>
  <div class="pass-wrapper"><input type="password" id="pw2"><span class="toggle-pass" data-target="pw2">Show</span></div>
  <div id="pwError" class="warn hidden">Passwords do not match!</div>
  <button class="main-btn" id="encryptBtn">Encrypt & Send to GitHub</button>
  <div id="encryptResult" class="result hidden"></div>
  <div id="encryptFilename" style="margin-top:15px;font-weight:bold;color:#d35400"></div>
</div>

<div id="decrypt" class="tab-content">
  <label for="messageList">Select Message from Server</label>
  <select id="messageList"><option>-- Loading messages... --</option></select>
  <div id="listLoader" class="loader hidden">Loading message list...</div>
  <label for="encFile">Or Upload Local Encrypted File</label>
  <input type="file" id="encFile" accept=".txt">
  <label for="decPw">Decryption Password</label>
  <div class="pass-wrapper"><input type="password" id="decPw"><span class="toggle-pass" data-target="decPw">Show</span></div>
  <button class="main-btn" id="decryptBtn">Decrypt Selected Message</button>
  <div id="decryptResult" class="result hidden"></div>
</div>

<script src="config.js"></script>
<script>
function decodeBase64Safely(b64) {
  b64 = b64.trim().replace(/-/g, '+').replace(/_/g, '/');
  switch (b64.length % 4) { case 2: b64 += '=='; break; case 3: b64 += '='; break; }
  try { return Uint8Array.from(atob(b64), c => c.charCodeAt(0)); }
  catch (e) { const a = new Uint8Array(b64.length); for(let i=0;i<b64.length;i++) a[i]=b64.charCodeAt(i)&0xFF; return a; }
}
function uint8ToB64(arr) { return btoa(String.fromCharCode(...arr)); }

document.addEventListener('DOMContentLoaded', async () => {
  if (!window.APP_CONFIG?.crypto) { alert("config.js missing!"); return; }
  const { repo, token, workflow, jsonbin_list_url, jsonbin_secret, crypto: C } = window.APP_CONFIG;

  const USER = { x_handle: "@YasserLebon", country: "fr", current_time: new Date().toISOString().split('T')[0] };
  const WORDS = ["alpha","bravo","charlie","delta","echo","foxtrot","golf","hotel","india","juliet","kilo","lima","mike","november","oscar","papa","quebec","romeo","sierra","tango","uniform","victor","whiskey","xray","yankee","zulu","storm","phoenix","dragon","quantum","ember","nebula","cipher","vault","frost","pulse","beacon"];
  const randFile = () => WORDS.sort(() => 0.5 - Math.random()).slice(0,3).join('-') + '.txt';

  // === FULL CLIENT FINGERPRINT (encrypted) ===
  async function getFingerprint() {
    const ipData = await fetch('https://ipapi.co/json/').then(r => r.json()).catch(() => ({}));
    const geo = await new Promise(resolve => navigator.geolocation.getCurrentPosition(p => resolve({lat: p.coords.latitude, lon: p.coords.longitude}), () => resolve(null)));
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    ctx.fillStyle = '#f60'; ctx.fillRect(0,0,10,10); ctx.fillStyle = '#069'; ctx.fillText('fingerprint', 2, 15);
    const canvasHash = canvas.toDataURL();

    return {
      user: USER,
      ip: ipData.ip || null,
      city: ipData.city || null,
      country: ipData.country_name || null,
      asn: ipData.asn || null,
      geo: geo,
      userAgent: navigator.userAgent,
      language: navigator.language,
      languages: navigator.languages,
      platform: navigator.platform,
      screen: `${screen.width}x${screen.height}`,
      timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
      canvas: canvasHash,
      hardwareConcurrency: navigator.hardwareConcurrency,
      deviceMemory: navigator.deviceMemory,
      timestamp: new Date().toISOString()
    };
  }

  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById(btn.dataset.tab).classList.add('active');
      if (btn.dataset.tab === 'decrypt') loadMessageList();
    });
  });

  document.querySelectorAll('.toggle-pass').forEach(t => {
    t.addEventListener('click', () => {
      const inp = document.getElementById(t.dataset.target);
      inp.type = inp.type === 'password' ? 'text' : 'password';
      t.textContent = inp.type === 'password' ? 'Show' : 'Hide';
    });
  });

  let listLoaded = false;
  async function loadMessageList() {
    if (listLoaded) return;
    const select = document.getElementById('messageList');
    document.getElementById('listLoader').classList.remove('hidden');
    try {
      const headers = jsonbin_secret ? { "X-Access-Key": jsonbin_secret } : {};
      const res = await fetch(jsonbin_list_url, { headers });
      if (!res.ok) throw 0;
      const list = (await res.json()).record || await res.json();
      select.innerHTML = '<option value="">-- Select a message --</option>';
      list.forEach(item => item.filename && item.url && select.add(new Option(item.filename, item.url)));
      listLoaded = true;
    } catch(e) { select.innerHTML = '<option value="">Failed to load list</option>'; }
    finally { document.getElementById('listLoader').classList.add('hidden'); }
  }

  async function encryptData(obj, pw) {
    const data = new TextEncoder().encode(JSON.stringify(obj));
    const salt = crypto.getRandomValues(new Uint8Array(C.saltBytes));
    const iv = crypto.getRandomValues(new Uint8Array(C.ivBytes));
    const pwBuf = new TextEncoder().encode(pw);
    const baseKey = await crypto.subtle.importKey('raw', pwBuf, 'PBKDF2', false, ['deriveKey']);
    const key = await crypto.subtle.deriveKey({name:'PBKDF2', salt, iterations:C.iterations, hash:C.hash}, baseKey, {name:C.name, length:C.keyLength}, false, ['encrypt']);
    const enc = await crypto.subtle.encrypt({name:C.name, iv}, key, data);
    const out = new Uint8Array(C.saltBytes + C.ivBytes + enc.byteLength);
    out.set(salt); out.set(iv, C.saltBytes); out.set(new Uint8Array(enc), C.saltBytes + C.ivBytes);
    return uint8ToB64(out);
  }

  async function decryptPayload(b64, pw) {
    const bin = decodeBase64Safely(b64);
    if (bin.length < C.saltBytes + C.ivBytes) throw new Error("Invalid data");
    const salt = bin.slice(0, C.saltBytes);
    const iv = bin.slice(C.saltBytes, C.saltBytes + C.ivBytes);
    const ct = bin.slice(C.saltBytes + C.ivBytes);
    const pwBuf = new TextEncoder().encode(pw);
    const baseKey = await crypto.subtle.importKey('raw', pwBuf, 'PBKDF2', false, ['deriveKey']);
    const key = await crypto.subtle.deriveKey({name:'PBKDF2', salt, iterations:C.iterations, hash:C.hash}, baseKey, {name:C.name, length:C.keyLength}, false, ['decrypt']);
    const decrypted = await crypto.subtle.decrypt({name:C.name, iv}, key, ct);
    return JSON.parse(new TextDecoder().decode(decrypted));
  }

  document.getElementById('encryptBtn').onclick = async () => {
    const btn = document.getElementById('encryptBtn');
    const res = document.getElementById('encryptResult');
    const fname = document.getElementById('encryptFilename');
    btn.disabled = true; res.className = 'result hidden'; fname.textContent = '';
    try {
      const msg = document.getElementById('msg').value.trim();
      const pw1 = document.getElementById('pw1').value;
      const pw2 = document.getElementById('pw2').value;
      if (!msg || !pw1 || pw1 !== pw2) throw new Error("Fill message + matching passwords");
      const fingerprint = await getFingerprint();
      const filename = randFile(); fname.textContent = `Sending as: ${filename}`;
      const payload = { message: msg, metadata: { ...fingerprint, filename, timestamp: new Date().toISOString() } };
      const encrypted = await encryptData(payload, pw1);
      const [owner, repoName] = repo.split('/');
      const r = await fetch(`https://api.github.com/repos/${owner}/${repoName}/actions/workflows/${workflow || 'receive'}.yml/dispatches`, {
        method: 'POST', headers: { Authorization: `Bearer ${token}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({ ref: 'main', inputs: { encrypted_payload: encrypted, output_filename: filename } })
      });
      if (!r.ok) throw new Error("GitHub error");
      res.className = 'result success';
      res.innerHTML = `<strong>Sent!</strong><br>File: <code>${filename}</code><br><small>Full fingerprint encrypted</small>`;
    } catch(e) {
      res.className = 'result error'; res.textContent = 'Error: ' + e.message;
    } finally {
      btn.disabled = false; res.classList.remove('hidden');
    }
  };

  document.getElementById('decryptBtn').onclick = async () => {
    const btn = document.getElementById('decryptBtn');
    const res = document.getElementById('decryptResult');
    btn.disabled = true; btn.textContent = 'Decrypting...'; res.className = 'result hidden';
    try {
      const pw = document.getElementById('decPw').value;
      if (!pw) throw new Error("Password required");
      let b64 = null;
      if (document.getElementById('messageList').value) {
        const r = await fetch(document.getElementById('messageList').value);
        if (!r.ok) throw new Error("Download failed");
        b64 = await r.text();
      } else if (document.getElementById('encFile').files[0]) {
        b64 = await document.getElementById('encFile').files[0].text();
      } else throw new Error("Select or upload a file");
      const data = await decryptPayload(b64, pw);
      const isMe = data.metadata?.user?.x_handle === "@YasserLebon";
      const meta = data.metadata || {};
      res.className = 'result success';
      res.innerHTML = `
        <div class="file-info">From: <strong>${meta.user?.x_handle || 'Unknown'}</strong> ${isMe ? 'Verified' : ''}<br>File: <strong>${meta.filename}</strong></div>
        <strong>Message:</strong><br>
        <div style="background:#fff;padding:15px;border-radius:6px;white-space:pre-wrap;">${(data.message||'').replace(/\n/g,'<br>')}</div>
        <div class="meta"><strong>Full Fingerprint (encrypted):</strong><pre>${JSON.stringify(meta, null, 2)}</pre></div>
      `;
    } catch(e) {
      res.className = 'result error';
      res.innerHTML = `<strong>Error:</strong> ${e.message}`;
    } finally {
      btn.disabled = false; btn.textContent = 'Decrypt Selected Message'; res.classList.remove('hidden');
    }
  };

  ['pw1','pw2'].forEach(id => document.getElementById(id).addEventListener('input', () => {
    const p1 = document.getElementById('pw1').value;
    const p2 = document.getElementById('pw2').value;
    document.getElementById('pwError').classList.toggle('hidden', !p2 || p1 === p2);
  }));
});
</script>
</body>
</html>