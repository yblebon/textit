<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Secure Drop • @YasserLebon</title>
<style>
  body{font-family:Arial,sans-serif;max-width:1000px;margin:40px auto;padding:20px;background:#f4f4f9;color:#333;line-height:1.6}
  h1{color:#2c3e50;text-align:center;margin-bottom:10px}
  .subtitle{color:#7f8c8d;text-align:center;font-size:15px;margin-bottom:30px}
  .tabs{margin-bottom:30px;text-align:center}
  .tab-btn{padding:12px 30px;margin:0 8px;font-size:16px;border:none;border-radius:8px;cursor:pointer;background:#ddd;transition:all .3s}
  .tab-btn.active{background:#27ae60;color:white}
  .tab-btn:hover{background:#2ecc71;color:white}
  .c{background:#fff;padding:35px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,.1);display:none}
  .c.active{display:block}
  label{display:block;margin-top:22px;font-weight:bold}
  input,textarea,select{width:100%;padding:12px;margin-top:8px;border:1px solid #ddd;border-radius:6px;font-size:16px}
  textarea{height:140px;resize:vertical;font-family:monospace}
  button.main-btn{margin-top:30px;padding:14px 32px;background:#27ae60;color:#fff;border:none;border-radius:8px;font-size:17px;cursor:pointer;width:100%}
  button.main-btn:hover{background:#1e8449}
  button.main-btn:disabled{background:#95a5a6;cursor:not-allowed}
  .result{margin-top:25px;padding:20px;border-radius:8px;font-family:monospace}
  .success{color:#27ae60;background:#d5f5e3}
  .error{color:#e74c3c;background:#fadbd8}
  .hidden{display:none}
  .warn{color:#e67e22;font-size:14px;margin-top:5px}
  .meta{background:#f8f9fa;padding:18px;border-radius:8px;margin-top:20px;font-size:14px}
  .meta pre{background:#f0f0f0;padding:12px;border-radius:6px;overflow-x:auto}
  .file-info{padding:12px;background:#fff3cd;border-radius:6px;font-weight:bold;margin-top:15px}
  .loader{margin-top:10px;color:#7f8c8d;font-style:italic}
</style>
</head>
<body>
<h1>Secure Drop</h1>
<div class="subtitle">
  Private encrypted messages • @YasserLebon • France<br>
  <small>November 17, 2025 02:36 PM CET</small>
</div>

<div class="tabs">
  <button class="tab-btn active" data-tab="encrypt">Encrypt & Send</button>
  <button class="tab-btn" data-tab="decrypt">Decrypt Message</button>
</div>

<div id="encrypt" class="c active">
  <label for="msg">Your Secret Message</label>
  <textarea id="msg" placeholder="Type your confidential message here..."></textarea>
  <label for="pw1">Encryption Password</label>
  <input type="password" id="pw1">
  <label for="pw2">Confirm Password</label>
  <input type="password" id="pw2">
  <div id="pwError" class="warn hidden">Passwords do not match!</div>
  <button class="main-btn" id="encryptBtn">Encrypt & Send to GitHub</button>
  <div id="encryptResult" class="result hidden"></div>
  <div id="encryptFilename" style="margin-top:15px;font-weight:bold;color:#d35400"></div>
</div>

<div id="decrypt" class="c">
  <label for="messageList">Select Message from Server</label>
  <select id="messageList"><option>-- Loading messages... --</option></select>
  <div id="listLoader" class="loader hidden">Loading message list...</div>
  <label for="encFile">Or Upload Local Encrypted File</label>
  <input type="file" id="encFile" accept=".txt">
  <label for="decPw">Decryption Password</label>
  <input type="password" id="decPw">
  <button class="main-btn" id="decryptBtn">Decrypt Selected Message</button>
  <div id="decryptResult" class="result hidden"></div>
</div>

<script src="config.js"></script>
<script>
// === SAFE BASE64 ===
function decodeBase64Safely(b64) {
  b64 = b64.trim().replace(/-/g, '+').replace(/_/g, '/');
  switch (b64.length % 4) { case 2: b64 += '=='; break; case 3: b64 += '='; break; }
  try { return Uint8Array.from(atob(b64), c => c.charCodeAt(0)); }
  catch (e) { const a = new Uint8Array(b64.length); for(let i=0;i<b64.length;i++) a[i]=b64.charCodeAt(i)&0xFF; return a; }
}
function uint8ToB64(arr) { return btoa(String.fromCharCode(...arr)); }

document.addEventListener('DOMContentLoaded', () => {
  if (!window.APP_CONFIG?.crypto) { alert("config.js missing!"); return; }
  const { repo, token, workflow, jsonbin_list_url, jsonbin_secret, crypto: C } = window.APP_CONFIG;

  const USER = { x_handle: "@YasserLebon", country: "fr", current_time: "2025-11-17T14:36:00+01:00" };
  const WORDS = ["alpha","bravo","charlie","delta","echo","foxtrot","golf","hotel","india","juliet","kilo","lima","mike","november","oscar","papa","quebec","romeo","sierra","tango","uniform","victor","whiskey","xray","yankee","zulu","storm","phoenix","dragon","quantum","ember","nebula","cipher","vault","frost","pulse","beacon"];
  const randFile = () => WORDS.sort(() => 0.5 - Math.random()).slice(0,3).join('-') + '.txt';

  // === LOAD MESSAGE LIST ===
  async function loadMessageList() {
    const select = document.getElementById('messageList');
    if (select.options.length > 1) return;
    document.getElementById('listLoader').classList.remove('hidden');
    try {
      const headers = jsonbin_secret ? { "X-Access-Key": jsonbin_secret } : {};
      const res = await fetch(jsonbin_list_url, { headers });
      if (!res.ok) throw 0;
      const list = (await res.json()).record || await res.json();
      select.innerHTML = '<option value="">-- Select a message --</option>';
      list.forEach(item => item.filename && item.url && select.add(new Option(item.filename, item.url)));
    } catch(e) { select.innerHTML = '<option value="">Failed to load</option>'; }
    finally { document.getElementById('listLoader').classList.add('hidden'); }
  }

  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.c').forEach(c => c.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      const tab = btn.dataset.tab;
      document.getElementById(tab).classList.add('active');
      btn.classList.add('active');
      if (tab === 'decrypt') loadMessageList();
    });
  });

  // === UNIVERSAL DECRYPT – Supports both old (iv+salt) and new (salt+iv) formats ===
  async function decryptPayload(b64, password) {
    const bin = decodeBase64Safely(b64);
    if (bin.length < C.saltBytes + C.ivBytes) throw new Error("Invalid data");

    const attempts = [
      { salt: bin.slice(0, C.saltBytes),        iv: bin.slice(C.saltBytes, C.saltBytes + C.ivBytes),        ct: bin.slice(C.saltBytes + C.ivBytes) },  // New format: salt first
      { salt: bin.slice(C.ivBytes, C.ivBytes + C.saltBytes), iv: bin.slice(0, C.ivBytes), ct: bin.slice(C.saltBytes + C.ivBytes) }   // Old format: iv first
    ];

    const pwBuf = new TextEncoder().encode(password);
    const baseKey = await crypto.subtle.importKey('raw', pwBuf, 'PBKDF2', false, ['deriveKey']);

    for (const {salt, iv, ct} of attempts) {
      try {
        const key = await crypto.subtle.deriveKey(
          { name: 'PBKDF2', salt, iterations: C.iterations, hash: C.hash },
          baseKey,
          { name: C.name, length: C.keyLength },
          false, ['decrypt']
        );
        const decrypted = await crypto.subtle.decrypt({ name: C.name, iv }, key, ct);
        return JSON.parse(new TextDecoder().decode(decrypted));
      } catch (e) { continue; }
    }
    throw new Error("Wrong password or corrupted file");
  }

  // === ENCRYPT – Always uses config values (salt first) ===
  async function encryptData(obj, password) {
    const data = new TextEncoder().encode(JSON.stringify(obj));
    const salt = crypto.getRandomValues(new Uint8Array(C.saltBytes));
    const iv = crypto.getRandomValues(new Uint8Array(C.ivBytes));
    const pwBuf = new TextEncoder().encode(password);
    const baseKey = await crypto.subtle.importKey('raw', pwBuf, 'PBKDF2', false, ['deriveKey']);
    const key = await crypto.subtle.deriveKey(
      { name: 'PBKDF2', salt, iterations: C.iterations, hash: C.hash },
      baseKey,
      { name: C.name, length: C.keyLength },
      false, ['encrypt']
    );
    const encrypted = await crypto.subtle.encrypt({ name: C.name, iv }, key, data);
    const result = new Uint8Array(C.saltBytes + C.ivBytes + encrypted.byteLength);
    result.set(salt, 0);
    result.set(iv, C.saltBytes);
    result.set(new Uint8Array(encrypted), C.saltBytes + C.ivBytes);
    return uint8ToB64(result);
  }

  // === ENCRYPT BUTTON ===
  document.getElementById('encryptBtn').addEventListener('click', async () => {
    const btn = document.getElementById('encryptBtn'), res = document.getElementById('encryptResult'), fnameDiv = document.getElementById('encryptFilename');
    res.className = 'result hidden'; fnameDiv.textContent = ''; btn.disabled = true;
    try {
      const msg = document.getElementById('msg').value.trim();
      const pw1 = document.getElementById('pw1').value, pw2 = document.getElementById('pw2').value;
      if (!msg || !pw1 || pw1 !== pw2) throw new Error("Message + matching password required");
      const filename = randFile(); fnameDiv.textContent = `Sending as: ${filename}`;
      const payload = { message: msg, metadata: { user: USER, filename, timestamp: new Date().toISOString() } };
      const encrypted = await encryptData(payload, pw1);
      const [owner, name] = repo.split('/');
      const r = await fetch(`https://api.github.com/repos/${owner}/${name}/actions/workflows/${workflow || 'receive'}.yml/dispatches`, {
        method: 'POST', headers: { Authorization: `Bearer ${token}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({ ref: 'main', inputs: { encrypted_payload: encrypted, output_filename: filename } })
      });
      if (!r.ok) throw new Error("GitHub error");
      res.className = 'result success'; res.innerHTML = `<strong>Sent!</strong> File: <code>${filename}</code>`;
    } catch(e) { res.className = 'result error'; res.textContent = 'Error: ' + e.message; }
    finally { btn.disabled = false; res.classList.remove('hidden'); }
  });

  // === DECRYPT BUTTON ===
  document.getElementById('decryptBtn').addEventListener('click', async () => {
    const btn = document.getElementById('decryptBtn'), res = document.getElementById('decryptResult');
    res.className = 'result hidden'; btn.disabled = true; btn.textContent = 'Decrypting...';
    let b64 = null;
    try {
      const pw = document.getElementById('decPw').value; if (!pw) throw new Error("Password required");
      const url = document.getElementById('messageList').value;
      const file = document.getElementById('encFile').files[0];
      if (url) { const r = await fetch(url); if (!r.ok) throw new Error("Download failed"); b64 = await r.text(); }
      else if (file) b64 = await file.text();
      else throw new Error("Select or upload a file");
      const data = await decryptPayload(b64, pw);
      const isMe = data.metadata?.user?.x_handle === USER.x_handle;
     

   res.className = 'result success';
      res.innerHTML = `
        <div class="file-info">From: <strong>${data.metadata?.user?.x_handle || 'Unknown'}</strong> ${isMe ? 'Verified' : ''}<br>File: <strong>${data.metadata?.filename}</strong></div>
        <strong>Message:</strong><br>
        <div style="background:#fff;padding:15px;border-radius:6px;white-space:pre-wrap;">${(data.message||'').replace(/\n/g,'<br>')}</div>
        <div class="meta"><strong>Metadata:</strong><pre>${JSON.stringify(data.metadata||{},null,2)}</pre></div>
      `;
    } catch(e) { res.className = 'result error'; res.innerHTML = `<strong>Error:</strong> ${e.message}`; }
    finally { btn.disabled = false; btn.textContent = 'Decrypt Selected Message'; res.classList.remove('hidden'); }
  });

  // Password match
  ['pw1','pw2'].forEach(id => document.getElementById(id).addEventListener('input', () => {
    const p1 = document.getElementById('pw1').value;
    const p2 = document.getElementById('pw2').value;
    document.getElementById('pwError').classList.toggle('hidden', !p2 || p1 === p2);
  }));
});
</-script>
</body>
</html>